{% extends "nbhosting.html" %}

{% block head_title %}
{{head_title}}
{% endblock %}

{% block title %}
{{title}}
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
{% if user.is_authenticated and user.is_staff %}
  <li class="breadcrumb-item staff"><a href="/staff/course/{{coursename}}">{{coursename}}</a></li>
  <li class="breadcrumb-item staff"><a href="/staff/courses/">courses</a></li>
{% endif %}
    <li class="breadcrumb-item"><a href='/welcome/'>home</a></li>
    <li class="breadcrumb-item"><a href='/auditor/courses'>courses</a></li>
    <li class="breadcrumb-item active"><a href="/auditor/notebook/{{coursename}}">{{coursename}}</a></li>
</ol>
{% endblock %}

{% block content %}


<!--  javascript -->
<script>
function update_header(string) {
    $('div.nbh-title>h2').html(string);    
}

function update_current_notebook(notebook) {
    $("div.notebook").each(function(index, div) {
        let $div = $(div);
        let current = $div.attr("data-notebook") == notebook;
        if (current) {
            $div.addClass("current");
            update_header($div.attr("data-notebook-title"));
        } else {
            $div.removeClass("current");
        }
    })
}
function iframe_src(url) {
    console.log(`iframe url becomes ${url}`);
    $("#nbhosting-jupyter")[0].src = url;
    focus_iframe();
}
/* initialize with track from url */
let global_track = "{{track.name}}";
function change_track(track){
    global_track = track;
}
function iframe_notebook(notebook) {
    console.log('iframe_notebook', this)
    let url=`/notebookGitRepo/{{coursename}}/${notebook}/{{student}}`;
    iframe_src(url);
    update_current_notebook(notebook);
}
function focus_iframe() {
    $("iframe")[0].contentWindow.focus();
}

function hideleft_toggle() {
    if ($("#hideleft-toggle").hasClass("hideleft")) {
        hideleft_off();
    } else {
        hideleft_on();
    }
    focus_iframe();
}
function hideleft_on() {
    $("#left-pane").addClass("hideleft");
    $("#iframe-container").addClass("hideleft");
    $("#hideleft-toggle").addClass("hideleft");
}
function hideleft_off() {
    $("#left-pane").removeClass("hideleft");
    $("#iframe-container").removeClass("hideleft");
    $("#hideleft-toggle").removeClass("hideleft");
}


function hidetop_toggle() {
    if ($("#hidetop-toggle").hasClass("hidetop")) {
        hidetop_off();
    } else {
        hidetop_on();
    }
    focus_iframe();
}
function hidetop_on() {
    $(".nbh-banner").addClass("hidetop");
    $(".nbh-body").addClass("hidetop");
    $("#hidetop-toggle").addClass("hidetop");
}
function hidetop_off() {
    $(".nbh-banner").removeClass("hidetop");
    $(".nbh-body").removeClass("hidetop");
    $("#hidetop-toggle").removeClass("hidetop");
}


function toggle_decorations() {
    hidetop_toggle();
    hideleft_toggle();
}
</script>


<!--  CSS -->
<style>
html, body {
    height: 100%;
    width: 100%;
}

.nbh-banner.hidetop {
    display: none;
}

/* 102px is the header size */
#left-pane, #iframe-container, #hideleft-toggle {
    top: 102px;
}
/* this one is 102px - 20px (toggle height) */
#hidetop-toggle {
    top: 82px;
}


.nbh-body.hidetop #iframe-container, .nbh-body.hidetop #left-pane, .nbh-body.hidetop #hideleft-toggle {
    top: 0px;
}

/* less space between top and left when both shown */
.nbh-body:not(.hidetop) #left-pane .left-upper.hidden + .left-middle > .track-sections { 
    margin-top: 0px;
}
.nbh-body:not(.hidetop) #left-pane .left-upper:not(.hidden) { 
    margin-top: 0px;
}

#left-pane {
    display: flex;
    flex-direction: column;
    position: absolute;
    bottom: 0px;
    left: 0px;
    /*
      this means use 1/6 for the left hand side panel
      must add up with the setting for iframe-container
    */
    right: 83%;
    padding: 0px;
    background-color: #e9ecef; /* from bootstrap jumbotron */
}

#left-pane.hideleft {
    right: 100%;
}

div.left-upper {
    margin: 10px 10px 0px 10px;
    padding: 10px;
    border-radius: 10px;
    border: 2px solid gray;
    background-color: white;
}

div.left-middle {
    overflow-y: auto;
}

div.left-bottom {
    /* margin-top: auto is important so that
       the box gets attached to the bottom of the viewport */
    margin: auto 10px 5px 10px;
    border-radius: 10px;
    /* tmp */
    border: 2px solid green;
    padding: 10px;
    background-color: white;
}

#hidetop-toggle {
    position: fixed;
    right: 0px;
    z-index: 100;
    transform: scaleY(-1);
}

#hidetop-toggle.hidetop {
    transform: scale(1);
    top: 0px;
}

#hidetop-toggle.hideleft {
    transform: scaleX(1);
    left: 0px;
}

#hideleft-toggle {
    position: fixed;
    left: 17%;
    z-index: 100;
    transform: scaleX(-1);
}

#hideleft-toggle.hideleft {
    transform: scaleX(1);
    left: 0px;
}

#iframe-container {
    position: absolute;
    bottom: 0px;
    left: 17%;
    right: 0px;
}

#iframe-container.hideleft {
    left: 0%;
}

iframe {
    height: 100%;
}

/* ----------- */

.track-name {
    border-radius: 5px;
    border: 1px solid gray;
    margin: 5px;
    padding: 4px 16px;
}
.track-name:not(.active) {
    background-color: #f0f0f0;
}

div.track-sections {
    padding: 10px 10px;
    margin: 10px;
    border-radius: 10px;
    border: 2px solid blue;
    background-color: white;
}

div.section {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-flex-start;
    padding-left: 10px;
    padding-right: 10px;
    padding-top: 0px;
}
div.section:last-child {
    padding-bottom: 0px;
}
.section-head {
    width: 100%;
    margin-bottom: 10px;
    font-size: 75%;
}
.notebook {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 0.5px solid #333;
    margin: 1px;
}
div.section>a>.notebook.current {
    background-color: #ffffff;
    border: 3px solid black;
}

.in-track {
    background-color: #ccc;
    /* background-color: #2E86C1;  blue-ish */
}
/* both means it exists and it's been copied */
.in-track.in-student {
    background-color: #afa;
    /* background-color: #17A589;  green-ish */
}
/* only in-student means somehow it's obsolete */
.in-student {
    background-color: #884EA0;  /* purple-ish */
}
.smaller{
    font-size: 60%;
}

iframe {
    background-image: url("/assets/img/loading.svg");
    background-repeat: no-repeat;
    background-size: 100%;
/*    background-position: center; */
 }

 .track-head, .file-head {
     width: 100%;
     font-size: 120%;
 }

.single-track-head {
    width: 100%;
    font-size: 80%;
}
.single-track-head:before {
    content: "\2933";
}

.jupyter {
    display: flex;
}

.classic, .lab {
    width: 50%;
    margin: 0px 6px;
    padding: 6px 0px;
    font-size: 75%;
}

.git {
    width: 100%;
    margin-top: 10px;
    font-size: 100%;
}

.transitionable {
    -webkit-transition: all 0.25s ease-in-out;
    -moz-transition: all 0.25s ease-in-out;
    -ms-transition: all 0.25s ease-in-out;
    -o-transition: all 0.25s ease-in-out;
    transition: all 0.25s ease-in-out;

}

.hidden {
    display: none;
}
</style>

<!------------------------------>
<div class="container" height="100%">
    <div id="hideleft-toggle" class="transitionable">
        <img src="/assets/img/right.svg" height="40px"
        onclick="toggle_decorations()"
        ></img>
    </div>
    <div id="hidetop-toggle" class="transitionable">
        <img src="/assets/img/down.svg" height="40px"
        onclick="toggle_decorations()"
        ></img>
    </div>
    
    <div id="left-pane" class="transitionable">

        <div class='left-upper transitionable {% if tracks|length_is:"1" %}hidden{% endif%}'>

            <h1 class="btn btn-outline-secondary track-head"
                data-toggle="tooltip" data-html="true"
                title="you may choose to navigate through one of the following tracks"
            >by track</h1>
            <div class="nav flex-column nav-pills" id="track-picker-tab" role="tablist" aria-orientation="vertical">
                {% for track_obj in tracks %}
                <a class="nav-link show track-name {% if track.name == track_obj.name %}active{% endif %}"
                    onclick="change_track('{{track_obj.name}}')"
                    id="sections-{{track_obj.name}}-tab"
                    data-toggle="pill" href="#sections-{{track_obj.name}}"
                    role="tab" aria-controls="sections-{{track_obj.name}}"
                    aria-selected="{% if track.name == track_obj.name %}true{% else %}false{% endif %}"
                >{{track_obj.name}}</a>
                {% endfor %}
            </div>
        </div>


        <div class="tab-content left-middle" id="track-picker-tabContent">

            {% for track_obj in tracks %}
            <div class="tab-pane fade track-sections transitionable
                        {% if track.name == track_obj.name %}active show{% endif %}"
                id="sections-{{track_obj.name}}" role="tabpanel"
                aria-labelledby="sections-{{track_obj.name}}-tab"
                >
                {% if tracks|length_is:"1" %}
                <h1 class="btn btn-outline-secondary single-track-head"
                    data-toggle="tooltip" data-html="true"
                    title="you may read along the single track<br/>
                           that this course offers">
                   </h1>
                {% endif%}

                {% for section in track_obj.sections %}
                <div class="section">
                    <a class="btn btn-outline-primary section-head"
                    {% autoescape off %}{{section.decorate_a}}{% endautoescape %}
                    >{{section.name}}</a>
                    {% for notebook_obj in section.notebooks %}
                    <a {% autoescape off %}{{notebook_obj.decorate_a}}{% endautoescape %}>
                        <div data-notebook="{{notebook_obj.clean_path}}"
                             data-notebook-title="{{notebook_obj.notebookname}}"
                             class="notebook {{notebook_obj.classes}}
                            {% if notebook_obj.clean_path == notebook %}current{% endif %}"
                        ></div>
                    </a>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>


        <div class="left-bottom">

            <h1 class="btn btn-outline-secondary file-head"
                data-toggle="tooltip" data-html="true"
                title="or, if you'd prefer through a regular jupyter browser
                <br/>note that in this case you'll only able to see notebooks
                <br/>that are <b>already present</b> in your workspace"
            >Jupy<wbr>ter</h1>
            <div class="jupyter">
                <a onclick="{iframe_src('/ipythonForward/{{coursename}}/{{student}}/tree'); update_header('Jupyter classic');}"
                    data-toggle="tooltip" data-html="true"
                    title="Jupyter classic will display the contents of your workdir
                    and spawn noteboks in separate tabs"
                    class="classic btn btn-outline-success"
                    >  clas<wbr>sic
                </a>
                <a onclick="{iframe_src('/ipythonForward/{{coursename}}/{{student}}/lab'); update_header('Jupyter lab');}"
                    target="nbhosting-jupyter"
                    data-toggle="tooltip" data-html="true"
                    title="with Jupyter lab you can edit all your contents from
                    within a single browser tab"
                    class="lab btn btn-outline-success"
                    >  lab
                </a>
            </div>

            <a onclick="iframe_src('{{gitpull_url}}')"
                class="btn btn-outline-danger git"
                data-toggle="tooltip" data-html="true"
                title="you may need to initialize</br>your workspace as a git repo<br/>this button will also update from upstream"
            > go git &amp; pull
            </a>
        </div>

    </div>

    <div id="iframe-container" class="transitionable">
        <iframe id="nbhosting-jupyter"
            height="100%"
            width="100%"
            src="{{iframe}}"
            onload="focus_iframe()"
        >
        </iframe>
    </div>
</div>

{% endblock %}
